#Домашнее задание  

**Работа с уровнями изоляции транзакции в PostgreSQL**
**Цель**: 
- научится работать с Google Cloud Platform на уровне Google Compute Engine (IaaS)
- научится управлять уровнем изолции транзации в PostgreSQL и понимать особенность работы уровней read commited и repeatable read  

###создать новый проект в Google Cloud Platform, например postgres2020-<yyyymmdd>, где yyyymmdd год, месяц и день вашего рождения (имя проекта должно быть уникально на уровне GCP)  
	
gcloud beta compute --project=nice-forge-295022 instances create dz001-1 --zone=us-central1-a --machine-type=e2-medium --subnet=default --network-tier=PREMIUM --maintenance-policy=MIGRATE --service-account=871797394481-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/trace.append --image=ubuntu-minimal-2004-focal-v20201028 --image-project=ubuntu-os-cloud --boot-disk-size=10GB --boot-disk-type=pd-ssd --boot-disk-device-name=dz001-1 --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any
	
###дать возможность доступа к этому проекту пользователю postgres202010@gmail.com с ролью Project Editor
доступ предоставлен  

###далее создать инстанс виртуальной машины Compute Engine с дефолтными параметрами  

ВМ создана  
Идентификатор экземпляра  
5409541204448961424  

###добавить свой ssh ключ в GCE metadata
ключ добавлен 

###зайти удаленным ssh (первая сессия), не забывайте про ssh-add
ssh -l alex 34.67.190.171  
Все ок.  

###поставить PostgreSQL
установка базы 
источник 
https://www.postgresql.org/download/linux/ubuntu/

*Create the file repository configuration:*
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
 *Import the repository signing key:*
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
*Update the package lists:*
sudo apt-get update
*Install the latest version of PostgreSQL.*
sudo apt-get -y install postgresql

*как вариант командной строки все команды в одну строчку : *
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt-get -y install postgresql


#зайти вторым ssh (вторая сессия)
зашел
в дальнейшем буду использовать определение как "второе окно"
первая сессия "первое окно"

# запустить везде psql из под пользователя postgres
*Первое окно : * 
sudo su postgres
 psql 
*Второе окно *
 sudo  -u postgres psql
 
# выключить auto commit
*Первое окно : * 
\echo :AUTOCOMMIT
\set AUTOCOMMIT OFF
*Второе окно *
\echo :AUTOCOMMIT
\set AUTOCOMMIT OFF
 

### сделать в первой сессии новую таблицу и наполнить ее данными
create table persons(id serial, first_name text, second_name text);
insert into persons(first_name, second_name) values('ivan', 'ivanov');
insert into persons(first_name, second_name) values('petr', 'petrov');
commit;

- посмотреть текущий уровень изоляции: show transaction isolation level
- начать новую транзакцию в обоих сессиях с дефолтным (не меняя) уровнем изоляции
- в первой сессии добавить новую запись
insert into persons(first_name, second_name) values('sergey', 'sergeev');
- сделать select * from persons во второй сессии
- видите ли вы новую запись и если да то почему?
- завершить первую транзакцию - commit;
- сделать select * from persons во второй сессии
- видите ли вы новую запись и если да то почему?
- завершите транзакцию во второй сессии
- начать новые но уже repeatable read транзации - set transaction isolation level repeatable read;
- в первой сессии добавить новую запись
insert into persons(first_name, second_name) values('sveta', 'svetova');
- сделать select * from persons во второй сессии
- видите ли вы новую запись и если да то почему?
- завершить первую транзакцию - commit;
- сделать select * from persons во второй сессии
- видите ли вы новую запись и если да то почему?
- завершить вторую транзакцию
- сделать select * from persons во второй сессии
- видите ли вы новую запись и если да то почему?
- остановите виртуальную машину но не удаляйте ее



 sudo su postgres
 psql 
 \c
 create database dztest;
CREATE DATABASE
 \c dztest 
 
  ## второе окно другой способ : 
 sudo  -u postgres psql
\c dztest 
## сначала отключили аутокоммит во втором окне 
\echo :AUTOCOMMIT
\set AUTOCOMMIT OFF

потом проверили что работает в первом и в первом же создали таблицу 
 \echo :AUTOCOMMIT
 ON
  create table t001(i serial,sun int);
  \dt
        List of relations
 Schema | Name | Type  |  Owner   
--------+------+-------+----------
 public | t001 | table | postgres
(1 row)

## во втором окне где автокоммит отключен : 
 
dztest=!# \dt
ERROR:  current transaction is aborted, commands ignored until end of transaction block
не видим таблицу. 
но во втором же окне сделали : 
commit;
написало : ROLLBACK
dztest=# 
dztest=# \dt
        List of relations
 Schema | Name | Type  |  Owner   
--------+------+-------+----------
 public | t001 | table | postgres
(1 row)

видим таблицу 
проверяем что автокоммит отключен во втором 
dztest=# \echo :AUTOCOMMIT
OFF

проверяем что включен в первом 
 \echo :AUTOCOMMIT
on

вставляем строки в первом окне (где работает автокоммит)
dztest=# insert into t001 (sun) values (100),(200),(300);
INSERT 0 3
dztest=# 
dztest=# select * from t001;
 i | sun 
---+-----
 1 | 100
 2 | 200
 3 | 300
(3 rows)

во втором окне все видим 

select * from t001;
 i | sun 
---+-----
 1 | 100
 2 | 200
 3 | 300

в первом отключаем автокоммит 
\echo :AUTOCOMMIT
\set AUTOCOMMIT OFF 
вставляем данные 
 insert into t001 (sun) values (400),(500),(600);
 select * from t001;
 i | sun 
---+-----
 1 | 100
 2 | 200
 3 | 300
 4 | 400
 5 | 500
 6 | 600
(6 rows)
видим в первом окне 

select * from t001;
 i | sun 
---+-----
 1 | 100
 2 | 200
 3 | 300
(3 rows)

видим во втором. делаем сомит во ВТОРОМ ! 
commit;
select * from t001;
 i | sun 
---+-----
 1 | 100
 2 | 200
 3 | 300
(3 rows)
- не поменялось 
и не должно было т.к. транзакция была в первом окне. 
делаем комит в первом 
commit; 
во ВТОРОМ 
select * from t001;
 i | sun 
---+-----
 1 | 100
 2 | 200
 3 | 300
 4 | 400
 5 | 500
 6 | 600
(6 rows)

Видим все :) 
-- переходим к уровням изоляции 
дополнительная шпаргалка : 
https://urvanov.ru/2017/01/06/%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D0%B8-%D0%B8%D0%B7%D0%BE%D0%BB%D1%8F%D1%86%D0%B8%D0%B8-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D0%B9/
 
  show transaction isolation level; 
 transaction_isolation 
-----------------------
 read committed
(1 row)

 